<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<meta name="robots" content="noindex" />
		<title>SLARG Admin</title>
		<link rel="stylesheet" href="/static/css/research-interests.css" />
		<!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/netlify-cms@2.10.192/dist/netlify-cms.css" /> -->
		<link href="/admin/config.yml" type="text/yaml" rel="cms-config-url" />
	</head>
	<body>
		<script src="https://unpkg.com/netlify-cms@^2.0.0/dist/netlify-cms.js"></script>
		<script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
		<script src="cloudflare-media-library.js"></script>
		<script src="cloudflare-image-preview.js"></script>
		<script>
			CMS.registerMediaLibrary(window.CloudflareMediaLibrary);
			CMS.registerWidget('researchInterests', window.ResearchInterestsControl);

			// Register preview stylesheet to match frontend styling
			CMS.registerPreviewStyle('/admin/preview.css');

			// Register custom image preview that adds Cloudflare variant
			try {
				var originalImageWidget = CMS.getWidget('image');
				if (originalImageWidget && originalImageWidget.control) {
					CMS.registerWidget('image', originalImageWidget.control, window.CloudflareImagePreview);
				}
			} catch (e) {
				console.error('Failed to register image widget:', e);
			}

			// Register preview template for projects collection that includes the image
			try {
				var ProjectPreview = createClass({
					render: function() {
						var entry = this.props.entry;
						var mainImage = entry.getIn(['data', 'main_image']);
						var title = entry.getIn(['data', 'title']);
						var startDate = entry.getIn(['data', 'start_date']);
						var endDate = entry.getIn(['data', 'end_date']);
						var body = this.props.widgetFor('body');

						// Handle Immutable.js List - extract first item
						if (mainImage && typeof mainImage.first === 'function') {
							mainImage = mainImage.first();
						} else if (Array.isArray(mainImage)) {
							mainImage = mainImage[0];
						}

						// Format dates
						var dateText = '';
						if (startDate) {
							var start = new Date(startDate);
							dateText = start.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
							if (endDate) {
								var end = new Date(endDate);
								dateText += ' â€“ ' + end.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
							}
						}

						return h('div', { className: 'project' },
							h('div', { className: 'project-label' }, 'RESEARCH PROJECT'),
							h('h1', {}, title),
							dateText ? h('div', { className: 'project-date' }, dateText) : null,
							mainImage ? h('img', {
								src: window.addCloudflareVariant ? window.addCloudflareVariant(mainImage) : mainImage
							}) : null,
							body
						);
					}
				});
				CMS.registerPreviewTemplate('projects', ProjectPreview);
			} catch (e) {
				console.error('Failed to register preview template:', e);
			}

			CMS.init();

			window.addEventListener('load', function () {
				const script = document.createElement('script');
				script.src = '/static/widgets/researchInterests.js';
				document.body.appendChild(script);
			});
		</script>
	</body>
</html>
